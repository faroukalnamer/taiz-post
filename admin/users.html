<?php
/**
 * ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ
 */
require_once __DIR__ . '/../config/init.php';

if (!isLoggedIn() || !hasRole(ROLE_ADMIN)) {
    flash('error', 'ÿ∫Ÿäÿ± ŸÖÿµÿ±ÿ≠ ŸÑŸÉ ÿ®ÿßŸÑŸàÿµŸàŸÑ', 'error');
    redirect('/login.php');
}

$user = currentUser();
$userModel = new User();

// ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™
if ($_SERVER['REQUEST_METHOD'] === 'POST' && validateCSRFToken($_POST['csrf_token'] ?? '')) {
    $action = $_POST['action'] ?? '';
    $userId = (int)($_POST['user_id'] ?? 0);
    
    if ($userId && $userId !== $user['id']) {
        switch ($action) {
            case 'activate':
                $userModel->activateByAdmin($userId);
                flash('success', 'ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ≠ÿ≥ÿßÿ® ÿ®ŸÜÿ¨ÿßÿ≠', 'success');
                break;
            case 'suspend':
                $userModel->suspend($userId);
                flash('success', 'ÿ™ŸÖ ÿ™ÿπŸÑŸäŸÇ ÿßŸÑÿ≠ÿ≥ÿßÿ®', 'success');
                break;
            case 'ban':
                $userModel->ban($userId);
                flash('success', 'ÿ™ŸÖ ÿ≠ÿ∏ÿ± ÿßŸÑÿ≠ÿ≥ÿßÿ®', 'success');
                break;
            case 'delete':
                $userModel->delete($userId);
                flash('success', 'ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ≠ÿ≥ÿßÿ®', 'success');
                break;
            case 'change_role':
                $role = $_POST['role'] ?? '';
                if (in_array($role, [ROLE_ADMIN, ROLE_MODERATOR, ROLE_MEMBER])) {
                    $userModel->changeRole($userId, $role);
                    flash('success', 'ÿ™ŸÖ ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿØŸàÿ± ÿ®ŸÜÿ¨ÿßÿ≠', 'success');
                }
                break;
        }
    }
    redirect('/admin/users.php');
}

// ÿßŸÑŸÅŸÑÿ™ÿ±ÿ©
$filters = [
    'status' => $_GET['status'] ?? '',
    'role' => $_GET['role'] ?? '',
    'search' => $_GET['search'] ?? ''
];

$users = $userModel->getAll($filters);
$flashMsg = flash('success');
?>
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ - <?= SITE_NAME ?></title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/admin.css">
</head>
<body>
    <div class="admin-layout">
        <?php include 'includes/sidebar.php'; ?>

        <main class="main-content">
            <header class="content-header">
                <h1>ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ</h1>
            </header>

            <?php if ($flashMsg): ?>
            <div class="alert alert-<?= $flashMsg['type'] ?>">
                <?= escape($flashMsg['message']) ?>
            </div>
            <?php endif; ?>

            <!-- Filters -->
            <div class="card mb-4">
                <form method="GET" class="filters-form">
                    <div class="filter-group">
                        <input type="text" name="search" placeholder="ÿ®ÿ≠ÿ´..." value="<?= escape($filters['search']) ?>">
                    </div>
                    <div class="filter-group">
                        <select name="status">
                            <option value="">ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ÿßŸÑÿßÿ™</option>
                            <option value="pending" <?= $filters['status'] === 'pending' ? 'selected' : '' ?>>ŸÖÿπŸÑŸÇ</option>
                            <option value="active" <?= $filters['status'] === 'active' ? 'selected' : '' ?>>ŸÜÿ¥ÿ∑</option>
                            <option value="suspended" <?= $filters['status'] === 'suspended' ? 'selected' : '' ?>>ŸÖŸàŸÇŸàŸÅ</option>
                            <option value="banned" <?= $filters['status'] === 'banned' ? 'selected' : '' ?>>ŸÖÿ≠ÿ∏Ÿàÿ±</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <select name="role">
                            <option value="">ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ÿØŸàÿßÿ±</option>
                            <option value="admin" <?= $filters['role'] === 'admin' ? 'selected' : '' ?>>ŸÖÿØŸäÿ±</option>
                            <option value="moderator" <?= $filters['role'] === 'moderator' ? 'selected' : '' ?>>ŸÖÿ¥ÿ±ŸÅ</option>
                            <option value="member" <?= $filters['role'] === 'member' ? 'selected' : '' ?>>ÿπÿ∂Ÿà</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">ÿ®ÿ≠ÿ´</button>
                    <a href="users.php" class="btn btn-secondary">ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ</a>
                </form>
            </div>

            <!-- Users Table -->
            <div class="card">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ</th>
                                <th>ÿßŸÑÿ®ÿ±ŸäÿØ</th>
                                <th>ÿßŸÑÿØŸàÿ±</th>
                                <th>ÿßŸÑÿ≠ÿßŸÑÿ©</th>
                                <th>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ</th>
                                <th>ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php foreach ($users as $u): ?>
                            <tr>
                                <td><?= $u['id'] ?></td>
                                <td>
                                    <div class="user-cell">
                                        <div class="avatar"><?= mb_substr($u['full_name'], 0, 1) ?></div>
                                        <div>
                                            <span class="name"><?= escape($u['full_name']) ?></span>
                                            <span class="username">@<?= escape($u['username']) ?></span>
                                        </div>
                                    </div>
                                </td>
                                <td><?= escape($u['email']) ?></td>
                                <td>
                                    <span class="role-badge role-<?= $u['role'] ?>">
                                        <?= $u['role'] === 'admin' ? 'ŸÖÿØŸäÿ±' : ($u['role'] === 'moderator' ? 'ŸÖÿ¥ÿ±ŸÅ' : 'ÿπÿ∂Ÿà') ?>
                                    </span>
                                </td>
                                <td>
                                    <span class="status-badge status-<?= $u['status'] ?>">
                                        <?php
                                        $statuses = ['pending' => 'ŸÖÿπŸÑŸÇ', 'active' => 'ŸÜÿ¥ÿ∑', 'suspended' => 'ŸÖŸàŸÇŸàŸÅ', 'banned' => 'ŸÖÿ≠ÿ∏Ÿàÿ±'];
                                        echo $statuses[$u['status']] ?? $u['status'];
                                        ?>
                                    </span>
                                </td>
                                <td><?= date('Y/m/d H:i', strtotime($u['created_at'])) ?></td>
                                <td>
                                    <?php if ($u['id'] !== $user['id']): ?>
                                    <div class="actions-dropdown">
                                        <button class="btn btn-sm btn-icon">‚ãÆ</button>
                                        <div class="dropdown-menu">
                                            <?php if ($u['status'] === 'pending'): ?>
                                            <form method="POST">
                                                <?= csrfField() ?>
                                                <input type="hidden" name="user_id" value="<?= $u['id'] ?>">
                                                <input type="hidden" name="action" value="activate">
                                                <button type="submit" class="dropdown-item text-success">‚úÖ ÿ™ŸÅÿπŸäŸÑ</button>
                                            </form>
                                            <?php endif; ?>
                                            
                                            <?php if ($u['status'] !== 'suspended'): ?>
                                            <form method="POST">
                                                <?= csrfField() ?>
                                                <input type="hidden" name="user_id" value="<?= $u['id'] ?>">
                                                <input type="hidden" name="action" value="suspend">
                                                <button type="submit" class="dropdown-item text-warning">‚è∏Ô∏è ÿ™ÿπŸÑŸäŸÇ</button>
                                            </form>
                                            <?php endif; ?>
                                            
                                            <?php if ($u['status'] !== 'banned'): ?>
                                            <form method="POST">
                                                <?= csrfField() ?>
                                                <input type="hidden" name="user_id" value="<?= $u['id'] ?>">
                                                <input type="hidden" name="action" value="ban">
                                                <button type="submit" class="dropdown-item text-error">üö´ ÿ≠ÿ∏ÿ±</button>
                                            </form>
                                            <?php endif; ?>
                                            
                                            <hr class="dropdown-divider">
                                            
                                            <form method="POST" class="role-form">
                                                <?= csrfField() ?>
                                                <input type="hidden" name="user_id" value="<?= $u['id'] ?>">
                                                <input type="hidden" name="action" value="change_role">
                                                <select name="role" onchange="this.form.submit()">
                                                    <option value="">ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿØŸàÿ±</option>
                                                    <option value="admin">ŸÖÿØŸäÿ±</option>
                                                    <option value="moderator">ŸÖÿ¥ÿ±ŸÅ</option>
                                                    <option value="member">ÿπÿ∂Ÿà</option>
                                                </select>
                                            </form>
                                            
                                            <hr class="dropdown-divider">
                                            
                                            <form method="POST" onsubmit="return confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑÿ≠ÿ∞ŸÅÿü')">
                                                <?= csrfField() ?>
                                                <input type="hidden" name="user_id" value="<?= $u['id'] ?>">
                                                <input type="hidden" name="action" value="delete">
                                                <button type="submit" class="dropdown-item text-error">üóëÔ∏è ÿ≠ÿ∞ŸÅ</button>
                                            </form>
                                        </div>
                                    </div>
                                    <?php endif; ?>
                                </td>
                            </tr>
                            <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
    document.querySelectorAll('.actions-dropdown').forEach(dropdown => {
        const btn = dropdown.querySelector('.btn-icon');
        const menu = dropdown.querySelector('.dropdown-menu');
        
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            document.querySelectorAll('.dropdown-menu.show').forEach(m => m.classList.remove('show'));
            menu.classList.toggle('show');
        });
    });
    
    document.addEventListener('click', () => {
        document.querySelectorAll('.dropdown-menu.show').forEach(m => m.classList.remove('show'));
    });
    </script>
</body>
</html>
